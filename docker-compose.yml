version: "3.8"

services:
  # -------------------------------------------------------------------
  # 1. INFRASTRUCTURE (Bases de données & Broker Local)
  # -------------------------------------------------------------------

  # --- Message Broker ---
  rabbitmq:
    image: rabbitmq:3-management
    container_name: ptk-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-user}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-password}
    networks:
      - ptk-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  # --- DB Auth ---
  postgres-auth:
    image: postgres:15-alpine
    container_name: ptk-db-auth
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: auth_db
    ports:
      - "5432:5432" # Port externe 5432
    volumes:
      - ./data/auth:/var/lib/postgresql/data
    networks:
      - ptk-network

  # --- DB Client ---
  postgres-client:
    image: postgres:15-alpine
    container_name: ptk-db-client
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: client_db
    ports:
      - "5433:5432" # Port externe 5433 (pour éviter conflit)
    volumes:
      - ./data/client:/var/lib/postgresql/data
    networks:
      - ptk-network

  # --- DB Product ---
  postgres-product:
    image: postgres:15-alpine
    container_name: ptk-db-product
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: product_db
    ports:
      - "5434:5432" # Port externe 5434
    volumes:
      - ./data/product:/var/lib/postgresql/data
    networks:
      - ptk-network

  # --- DB Order ---
  postgres-order:
    image: postgres:15-alpine
    container_name: ptk-db-order
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: order_db
    ports:
      - "5435:5432" # Port externe 5435
    volumes:
      - ./data/order:/var/lib/postgresql/data
    networks:
      - ptk-network

  # -------------------------------------------------------------------
  # 2. MICRO-SERVICES (NestJS + BDD Locales Docker)
  # -------------------------------------------------------------------

  auth-service:
    build:
      context: ../ptk-auth-service
      target: development
    container_name: ptk-service-auth
    command: sh -c "npx prisma migrate deploy && npm run start:dev"
    ports:
      - "3001:3000"
    environment:
      - PORT=3000
      # Connexion interne Docker vers le service postgres-auth
      - DATABASE_URL=postgresql://user:password@postgres-auth:5432/auth_db?schema=public
      - JWT_SECRET=SUPER_SECRET_KEY_A_CHANGER_DANS_ENV
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER:-user}:${RABBITMQ_DEFAULT_PASS:-password}@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-auth:
        condition: service_started
    networks:
      - ptk-network
    volumes:
      - ../ptk-auth-service:/usr/src/app
      - /usr/src/app/node_modules

  client-service:
    build:
      context: ../ptk-client-service
      target: development
    container_name: ptk-service-clients
    command: sh -c "npx prisma migrate deploy && npm run start:dev"
    ports:
      - "3002:3000"
    environment:
      - PORT=3000
      # Connexion interne Docker vers le service postgres-client
      - DATABASE_URL=postgresql://user:password@postgres-client:5432/client_db?schema=public
      - JWT_SECRET=SUPER_SECRET_KEY_A_CHANGER_DANS_ENV
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER:-user}:${RABBITMQ_DEFAULT_PASS:-password}@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-client:
        condition: service_started
    networks:
      - ptk-network
    volumes:
      - ../ptk-client-service:/usr/src/app
      - /usr/src/app/node_modules

  product-service:
    build:
      context: ../ptk-product-service
      target: development
    container_name: ptk-service-products
    command: sh -c "npx prisma migrate deploy && npm run start:dev"
    ports:
      - "3003:3000"
    environment:
      - PORT=3000
      # Connexion interne Docker vers le service postgres-product
      - DATABASE_URL=postgresql://user:password@postgres-product:5432/product_db?schema=public
      - JWT_SECRET=SUPER_SECRET_KEY_A_CHANGER_DANS_ENV
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER:-user}:${RABBITMQ_DEFAULT_PASS:-password}@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-product:
        condition: service_started
    networks:
      - ptk-network
    volumes:
      - ../ptk-product-service:/usr/src/app
      - /usr/src/app/node_modules

  order-service:
    build:
      context: ../ptk-order-service
      target: development
    container_name: ptk-service-orders
    command: sh -c "npx prisma migrate deploy && npm run start:dev"
    ports:
      - "3004:3000"
    environment:
      - PORT=3000
      # Connexion interne Docker vers le service postgres-order
      - DATABASE_URL=postgresql://user:password@postgres-order:5432/order_db?schema=public
      - JWT_SECRET=SUPER_SECRET_KEY_A_CHANGER_DANS_ENV
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER:-user}:${RABBITMQ_DEFAULT_PASS:-password}@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-order:
        condition: service_started
    networks:
      - ptk-network
    volumes:
      - ../ptk-order-service:/usr/src/app
      - /usr/src/app/node_modules

  # -------------------------------------------------------------------
  # 3. MONITORING
  # -------------------------------------------------------------------
  prometheus:
    image: prom/prometheus
    container_name: ptk-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - ptk-network

  grafana:
    image: grafana/grafana
    container_name: ptk-grafana
    ports:
      - "3005:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    networks:
      - ptk-network

networks:
  ptk-network:
    driver: bridge
